<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>// Place global declarations here.


typedef struct{
    int f_out;
    int s_out;
    bool control_flow;
}belt_config;
 
 const int BELTS = 2;
 const int STATIONS = 6;
 const int SENSORS = 7;
 
 const int BELT_SPEED = 1;
 const int MAX_SLOTS = 32;
 
 int BELT_SLOTS[BELTS] = {4, 5};
 int BELT_ITEMS[BELTS] = {4, 1};
 
 belt_config CONFIG[BELTS] = {
     {1, 0, false},
     {0, 0, false}
 };
 
 typedef int[0, BELTS-1] belt_t;
 typedef int[0, STATIONS-1] station_t;
 typedef int[0, SENSORS-1] sensor_t;
 
 broadcast chan init_done, belt_move;
 chan belt_in[BELTS];
 chan station_in[STATIONS];
 chan sensor_in[SENSORS];

int belts[BELTS][MAX_SLOTS];</declaration>
	<template>
		<name>Initializer</name>
		<declaration>clock x;</declaration>
		<location id="id0" x="-170" y="-8">
			<name x="-221" y="-42">init_start</name>
			<committed/>
		</location>
		<location id="id1" x="59" y="-8">
			<name x="25" y="-59">belt_sync</name>
			<label kind="invariant" x="0" y="-42">x &lt;= 1/BELT_SPEED</label>
		</location>
		<init ref="id0"/>
		<transition id="id2">
			<source ref="id1"/>
			<target ref="id1"/>
			<label kind="guard" x="42" y="76">x == 1/BELT_SPEED</label>
			<label kind="synchronisation" x="59" y="93">belt_move!</label>
			<label kind="assignment" x="85" y="110">x=0</label>
			<nail x="59" y="76"/>
			<nail x="144" y="76"/>
			<nail x="144" y="-8"/>
		</transition>
		<transition id="id3">
			<source ref="id0"/>
			<target ref="id1"/>
			<label kind="synchronisation" x="-110" y="-34">init_done!</label>
			<label kind="assignment" x="-102" y="-8">x = 0</label>
		</transition>
	</template>
	<template>
		<name x="5" y="5">Conveyor_Belt</name>
		<parameter>belt_t id, station_t stat_id, sensor_t sens_id</parameter>
		<declaration>// Place local declarations here.
clock x;
int flow_counter;
bool out_ready;

void build() {
    int i;
    
    for (i = 0; i &lt; BELT_ITEMS[id]; i++) { //slot 0 Ã¨ il piu avanzato
        belts[id][i] = 1;
    }
    
    flow_counter = 0; //to implement rule for green bar
}

void move() {
    int i;
    //out_ready = belts[id][0];
    
    if ( belts[id][0] ) {
        flow_counter = flow_counter % 2;    //??
        flow_counter++;
    }
    
    for ( i = 1; i &lt;= BELT_SLOTS[id]; i++) {
        belts[id][i-1] = belts[id][i];
    }
    
    belts[id][i-1] = 0;    //BELT_SLOTS[id]-1 quindi sempre ultimo slot
}

void add_last() {
    belts[id][BELT_SLOTS[id]-1] = 1;
}

int send_to() {
    if ( CONFIG[id].control_flow &amp;&amp; flow_counter == 2) {
        
        return CONFIG[id].s_out;
    }
    
    return CONFIG[id].f_out;
}</declaration>
		<location id="id4" x="-518" y="-161">
			<name x="-544" y="-195">start</name>
		</location>
		<location id="id5" x="-237" y="-161">
			<name x="-263" y="-195">working</name>
			<label kind="invariant" x="-306" y="-212">x &lt;= 1/BELT_SPEED</label>
		</location>
		<location id="id6" x="-238" y="42">
			<name x="-374" y="84">moving</name>
			<label kind="invariant" x="-374" y="59">x &lt;= 1/BELT_SPEED</label>
		</location>
		<location id="id7" x="-42" y="42">
		</location>
		<init ref="id4"/>
		<transition id="id8">
			<source ref="id7"/>
			<target ref="id5"/>
			<nail x="-42" y="-161"/>
		</transition>
		<transition id="id9">
			<source ref="id6"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="-204" y="-43">send_piece[id]?</label>
			<label kind="assignment" x="-204" y="-17">send(),move()</label>
			<nail x="-144" y="8"/>
		</transition>
		<transition id="id10">
			<source ref="id6"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="-178" y="84">move[id]?</label>
			<label kind="assignment" x="-178" y="102">move()</label>
			<nail x="-144" y="84"/>
		</transition>
		<transition id="id11">
			<source ref="id5"/>
			<target ref="id6"/>
			<label kind="guard" x="-408" y="-119">x == 1/BELT_SPEED</label>
			<label kind="synchronisation" x="-408" y="-102">sensor_in[sens_id]!</label>
			<label kind="assignment" x="-408" y="-85">x = 0</label>
			<nail x="-238" y="-102"/>
		</transition>
		<transition id="id12">
			<source ref="id4"/>
			<target ref="id5"/>
			<label kind="synchronisation" x="-434" y="-183">init_done?</label>
			<label kind="assignment" x="-433" y="-161">build(), x = 0</label>
		</transition>
	</template>
	<template>
		<name>Sensor</name>
		<parameter>sensor_t id, belt_t id, station_t stat_id</parameter>
		<declaration>

bool checkOccupied() {
    return belts[belt_id][belt_slot];
}
</declaration>
		<location id="id13" x="-297" y="-68">
		</location>
		<location id="id14" x="-161" y="-68">
			<name x="-178" y="-51">check</name>
		</location>
		<location id="id15" x="-161" y="-178">
		</location>
		<location id="id16" x="-34" y="-68">
		</location>
		<init ref="id13"/>
		<transition id="id17">
			<source ref="id14"/>
			<target ref="id16"/>
		</transition>
		<transition id="id18">
			<source ref="id14"/>
			<target ref="id15"/>
		</transition>
		<transition id="id19">
			<source ref="id13"/>
			<target ref="id14"/>
			<label kind="synchronisation" x="-272" y="-93">init_done?</label>
		</transition>
	</template>
	<template>
		<name>Station</name>
		<parameter>station_t id, int processing_time, belt_t belt_id</parameter>
		<declaration>clock x;

bool busy;</declaration>
		<location id="id20" x="-280" y="-110">
		</location>
		<location id="id21" x="-110" y="-110">
			<name x="-120" y="-144">waiting</name>
		</location>
		<location id="id22" x="-110" y="17">
			<name x="-84" y="8">processing</name>
			<label kind="invariant" x="-178" y="42">x&lt;=processing_time</label>
		</location>
		<init ref="id20"/>
		<transition id="id23">
			<source ref="id22"/>
			<target ref="id21"/>
			<label kind="guard" x="-323" y="-76">x == processing_time</label>
			<label kind="synchronisation" x="-323" y="-51">belt_in[belt_id]!</label>
			<nail x="-153" y="-17"/>
			<nail x="-153" y="-76"/>
		</transition>
		<transition id="id24">
			<source ref="id21"/>
			<target ref="id22"/>
			<label kind="synchronisation" x="-51" y="-68">station_in[id]?</label>
			<label kind="assignment" x="-51" y="-51">x=0</label>
			<nail x="-68" y="-76"/>
			<nail x="-68" y="-17"/>
		</transition>
		<transition id="id25">
			<source ref="id20"/>
			<target ref="id21"/>
			<label kind="synchronisation" x="-262" y="-127">init_done?</label>
		</transition>
	</template>
	<system>// Place template instantiations here.
I = Initializer();
S1 = Station(0, 5, 0);
S2 = Station(0, 5, 1);
system I, Conveyor_Belt, S1, S2;
</system>
	<queries>
		<query>
			<formula/>
			<comment/>
		</query>
	</queries>
</nta>
