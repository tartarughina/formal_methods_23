<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>// Place global declarations here.

const int SENSORS = 11;
const int BELTS = 9;
const int STATIONS = 6;
const int MERGERS = 1;
const int FLOW_CONTROLLERS = 1;

const int BELT_SPEED = 1;
const int MAX_SLOTS = 32;

typedef int[0, SENSORS-1] sensor_t;
typedef int[0, BELTS-1] belt_t;
typedef int[0, STATIONS+MERGERS+FLOW_CONTROLLERS-1] station_t;

typedef int[-1, MAX_SLOTS-1] pos_t;
typedef struct { pos_t head, tail, length; int pieces; } config_t;

config_t belt_conf[BELTS] = {{3, 14, 17, 11}, {3, 13, 20, 0}, {1, -1, 25, 0}, {-1, -1, 2, 0}, {4, 13, 16, 0}, {3, 6, 8, 0}, {-1, -1, 5, 0}, {-1, -1, 4, 0}, {1, 3, 4, 0}};

// signal for all the sensors placed on a belt
broadcast chan move[BELTS];
broadcast chan tick;
broadcast chan init_done;

// either we change the logic of the sensor to listen for the load signal or put another param to the station avoiding
chan load[BELTS];
chan push[STATIONS+MERGERS+FLOW_CONTROLLERS];
chan free[STATIONS+MERGERS+FLOW_CONTROLLERS];
chan offload[STATIONS+MERGERS+FLOW_CONTROLLERS];

int belts[BELTS][MAX_SLOTS];
bool gate[BELTS];
int FLOW_OUTPUTS[2] = {3, 4};</declaration>
	<template>
		<name>TailSensor</name>
		<parameter>sensor_t id, belt_t belt, pos_t pos, station_t station</parameter>
		<declaration>bool pos_occupied() {
    return belts[belt][pos];
}</declaration>
		<location id="id0" x="153" y="-289">
			<name x="136" y="-323">start</name>
		</location>
		<location id="id1" x="-8" y="-25">
			<name x="0" y="-17">queueing</name>
		</location>
		<location id="id2" x="306" y="-25">
			<name x="323" y="-17">queue_full</name>
		</location>
		<location id="id3" x="-8" y="195">
			<name x="8" y="161">offload_station</name>
			<committed/>
		</location>
		<location id="id4" x="306" y="195">
			<name x="331" y="187">hold_station</name>
		</location>
		<init ref="id0"/>
		<transition id="id5">
			<source ref="id0"/>
			<target ref="id2"/>
			<label kind="guard" x="204" y="-238">pos_occupied()</label>
			<label kind="synchronisation" x="212" y="-212">init_done?</label>
		</transition>
		<transition id="id6">
			<source ref="id1"/>
			<target ref="id1"/>
			<label kind="guard" x="-102" y="-144">!pos_occupied()</label>
			<label kind="synchronisation" x="-102" y="-127">move[belt]?</label>
			<nail x="-8" y="-102"/>
			<nail x="-93" y="-102"/>
		</transition>
		<transition id="id7">
			<source ref="id2"/>
			<target ref="id1"/>
			<label kind="guard" x="76" y="-144">!pos_occupied()</label>
			<label kind="synchronisation" x="51" y="-119">move[belt]?</label>
			<nail x="161" y="-110"/>
		</transition>
		<transition id="id8">
			<source ref="id2"/>
			<target ref="id2"/>
			<label kind="guard" x="425" y="-85">pos_occupied()</label>
			<label kind="synchronisation" x="425" y="-59">move[belt]?</label>
			<nail x="407" y="-25"/>
			<nail x="407" y="-102"/>
		</transition>
		<transition id="id9">
			<source ref="id4"/>
			<target ref="id4"/>
			<label kind="guard" x="306" y="272">pos_occupied()</label>
			<label kind="synchronisation" x="306" y="289">move[belt]?</label>
			<nail x="306" y="272"/>
			<nail x="408" y="272"/>
		</transition>
		<transition id="id10">
			<source ref="id1"/>
			<target ref="id3"/>
			<label kind="synchronisation" x="-221" y="76">offload[station]?</label>
			<nail x="-68" y="85"/>
		</transition>
		<transition id="id11">
			<source ref="id3"/>
			<target ref="id1"/>
			<label kind="synchronisation" x="0" y="76">offload[station]!</label>
		</transition>
		<transition id="id12">
			<source ref="id4"/>
			<target ref="id3"/>
			<label kind="guard" x="144" y="170">!pos_occupied()</label>
			<label kind="synchronisation" x="144" y="204">move[belt]?</label>
		</transition>
		<transition id="id13">
			<source ref="id2"/>
			<target ref="id4"/>
			<label kind="synchronisation" x="314" y="68">offload[station]?</label>
		</transition>
		<transition id="id14">
			<source ref="id1"/>
			<target ref="id2"/>
			<label kind="guard" x="85" y="-51">pos_occupied()</label>
			<label kind="synchronisation" x="85" y="-17">move[belt]?</label>
		</transition>
		<transition id="id15">
			<source ref="id0"/>
			<target ref="id1"/>
			<label kind="guard" x="-25" y="-238">!pos_occupied()</label>
			<label kind="synchronisation" x="-25" y="-212">init_done?</label>
		</transition>
	</template>
	<template>
		<name>HeadSensor</name>
		<parameter>sensor_t id, belt_t belt, pos_t pos, station_t station</parameter>
		<location id="id16" x="8" y="272">
			<name x="-51" y="263">start</name>
		</location>
		<location id="id17" x="8" y="-25">
			<name x="-127" y="-59">station_free</name>
		</location>
		<location id="id18" x="433" y="-25">
			<name x="450" y="-51">station_busy</name>
		</location>
		<location id="id19" x="221" y="-25">
			<name x="187" y="-59">triggered</name>
		</location>
		<init ref="id16"/>
		<transition id="id20">
			<source ref="id18"/>
			<target ref="id19"/>
			<label kind="guard" x="263" y="-153">belts[belt][pos]</label>
			<label kind="synchronisation" x="263" y="-127">free[station]?</label>
			<label kind="assignment" x="263" y="-102">gate[belt] = true</label>
			<nail x="331" y="-68"/>
		</transition>
		<transition id="id21">
			<source ref="id16"/>
			<target ref="id19"/>
			<label kind="guard" x="229" y="119">belts[belt][pos]</label>
			<label kind="synchronisation" x="229" y="144">init_done?</label>
			<label kind="assignment" x="229" y="170">gate[belt] = true</label>
			<nail x="221" y="272"/>
		</transition>
		<transition id="id22">
			<source ref="id19"/>
			<target ref="id18"/>
			<label kind="synchronisation" x="280" y="-17">move[belt]?</label>
			<label kind="assignment" x="246" y="0">gate[belt] = false</label>
		</transition>
		<transition id="id23">
			<source ref="id17"/>
			<target ref="id19"/>
			<label kind="guard" x="42" y="-51">belts[belt][pos]</label>
			<label kind="synchronisation" x="68" y="-17">move[belt]?</label>
		</transition>
		<transition id="id24">
			<source ref="id18"/>
			<target ref="id17"/>
			<label kind="guard" x="127" y="-263">!belts[belt][pos]</label>
			<label kind="synchronisation" x="127" y="-246">free[station]?</label>
			<label kind="assignment" x="127" y="-229">gate[belt] = true</label>
			<nail x="433" y="-204"/>
			<nail x="102" y="-204"/>
			<nail x="102" y="-102"/>
		</transition>
		<transition id="id25">
			<source ref="id18"/>
			<target ref="id18"/>
			<label kind="synchronisation" x="442" y="59">move[belt]?</label>
			<nail x="433" y="51"/>
			<nail x="544" y="51"/>
			<nail x="544" y="-25"/>
		</transition>
		<transition id="id26">
			<source ref="id17"/>
			<target ref="id17"/>
			<label kind="synchronisation" x="-59" y="-136">free[station]?</label>
			<label kind="assignment" x="-59" y="-119">gate[belt] = true</label>
			<nail x="-34" y="-85"/>
			<nail x="51" y="-85"/>
		</transition>
		<transition id="id27">
			<source ref="id17"/>
			<target ref="id17"/>
			<label kind="guard" x="-195" y="0">!belts[belt][pos]</label>
			<label kind="synchronisation" x="-195" y="17">move[belt]?</label>
			<nail x="-68" y="-25"/>
			<nail x="-25" y="34"/>
		</transition>
		<transition id="id28">
			<source ref="id16"/>
			<target ref="id17"/>
			<label kind="guard" x="17" y="119">!belts[belt][pos]</label>
			<label kind="synchronisation" x="17" y="144">init_done?</label>
			<label kind="assignment" x="17" y="170">gate[belt] = true</label>
		</transition>
	</template>
	<template>
		<name>FlowController</name>
		<parameter>station_t id</parameter>
		<declaration>int counter;

void build() {
    counter = 0;
}

belt_t dest() {
    if (counter == 3) {
        return FLOW_OUTPUTS[1];
    }
       
    return FLOW_OUTPUTS[0];   
}

void update() {
    if (counter == 3) {
        counter = 0;
    }
    
    counter++;
}</declaration>
		<location id="id29" x="-298" y="-34">
			<name x="-357" y="-51">start</name>
		</location>
		<location id="id30" x="-86" y="-34">
			<name x="-119" y="-68">wait_piece</name>
		</location>
		<location id="id31" x="-85" y="170">
			<name x="-136" y="187">wait_movement</name>
		</location>
		<location id="id32" x="161" y="170">
			<name x="178" y="161">load_dest</name>
			<committed/>
		</location>
		<location id="id33" x="161" y="-34">
			<name x="127" y="-68">free_sensor</name>
			<committed/>
		</location>
		<init ref="id29"/>
		<transition id="id34">
			<source ref="id32"/>
			<target ref="id33"/>
			<label kind="synchronisation" x="170" y="51">load[dest()]!</label>
		</transition>
		<transition id="id35">
			<source ref="id33"/>
			<target ref="id30"/>
			<label kind="synchronisation" x="-8" y="-59">free[id]!</label>
		</transition>
		<transition id="id36">
			<source ref="id31"/>
			<target ref="id32"/>
			<label kind="synchronisation" x="-17" y="144">move[dest()]?</label>
		</transition>
		<transition id="id37">
			<source ref="id30"/>
			<target ref="id31"/>
			<label kind="synchronisation" x="-76" y="51">push[id]?</label>
			<label kind="assignment" x="-76" y="76">update()</label>
		</transition>
		<transition id="id38">
			<source ref="id29"/>
			<target ref="id30"/>
			<label kind="synchronisation" x="-238" y="-59">init_done?</label>
			<label kind="assignment" x="-238" y="-25">build()</label>
		</transition>
	</template>
	<template>
		<name>Merger</name>
		<parameter>station_t id, belt_t belt</parameter>
		<location id="id39" x="-264" y="-77">
			<name x="-323" y="-93">start</name>
		</location>
		<location id="id40" x="-25" y="-76">
			<name x="-51" y="-110">waiting</name>
		</location>
		<location id="id41" x="-25" y="161">
		</location>
		<location id="id42" x="246" y="161">
			<committed/>
		</location>
		<init ref="id39"/>
		<transition id="id43">
			<source ref="id42"/>
			<target ref="id40"/>
			<label kind="synchronisation" x="110" y="17">load[belt]!</label>
		</transition>
		<transition id="id44">
			<source ref="id41"/>
			<target ref="id42"/>
			<label kind="synchronisation" x="59" y="136">move[belt]?</label>
		</transition>
		<transition id="id45">
			<source ref="id40"/>
			<target ref="id41"/>
			<label kind="synchronisation" x="-17" y="42">push[id]?</label>
		</transition>
		<transition id="id46">
			<source ref="id39"/>
			<target ref="id40"/>
			<label kind="synchronisation" x="-195" y="-102">init_done?</label>
		</transition>
	</template>
	<template>
		<name>Station</name>
		<parameter>station_t id, int processing_time, belt_t belt, bool sensor, bool guard_sensor</parameter>
		<declaration>clock x;</declaration>
		<location id="id47" x="-408" y="-144">
			<name x="-425" y="-178">start</name>
		</location>
		<location id="id48" x="-110" y="-144">
			<name x="-136" y="-178">waiting</name>
		</location>
		<location id="id49" x="-110" y="76">
			<name x="-153" y="93">processing</name>
			<label kind="invariant" x="-306" y="68">x &lt;= processing_time</label>
		</location>
		<location id="id50" x="212" y="76">
			<name x="153" y="93">processing_over</name>
			<committed/>
		</location>
		<location id="id51" x="476" y="76">
			<name x="425" y="42">waiting_queue</name>
		</location>
		<location id="id52" x="476" y="-144">
			<name x="425" y="-178">offload_piece</name>
			<committed/>
		</location>
		<location id="id53" x="212" y="-144">
			<name x="161" y="-178">update_sensor</name>
			<committed/>
		</location>
		<init ref="id47"/>
		<transition id="id54">
			<source ref="id53"/>
			<target ref="id48"/>
			<label kind="guard" x="0" y="-272">!guard_sensor</label>
			<nail x="59" y="-246"/>
		</transition>
		<transition id="id55">
			<source ref="id50"/>
			<target ref="id52"/>
			<label kind="guard" x="280" y="-59">!sensor</label>
		</transition>
		<transition id="id56">
			<source ref="id52"/>
			<target ref="id53"/>
			<label kind="synchronisation" x="297" y="-136">load[belt]!</label>
		</transition>
		<transition id="id57">
			<source ref="id53"/>
			<target ref="id48"/>
			<label kind="guard" x="0" y="-119">guard_sensor</label>
			<label kind="synchronisation" x="0" y="-136">free[id]!</label>
		</transition>
		<transition id="id58">
			<source ref="id51"/>
			<target ref="id52"/>
			<label kind="synchronisation" x="501" y="-51">offload[id]?</label>
		</transition>
		<transition id="id59">
			<source ref="id50"/>
			<target ref="id51"/>
			<label kind="guard" x="323" y="85">sensor</label>
			<label kind="synchronisation" x="323" y="110">offload[id]!</label>
			<nail x="450" y="76"/>
		</transition>
		<transition id="id60">
			<source ref="id49"/>
			<target ref="id50"/>
			<label kind="guard" x="-51" y="51">x == processing_time</label>
		</transition>
		<transition id="id61">
			<source ref="id48"/>
			<target ref="id49"/>
			<label kind="synchronisation" x="-102" y="-51">push[id]?</label>
			<label kind="assignment" x="-102" y="-25">x = 0</label>
		</transition>
		<transition id="id62">
			<source ref="id47"/>
			<target ref="id48"/>
			<label kind="synchronisation" x="-331" y="-170">init_done?</label>
		</transition>
	</template>
	<template>
		<name>Belt</name>
		<parameter>belt_t id, station_t station</parameter>
		<declaration>pos_t head;
pos_t tail;
pos_t length;

void build() {
    //int i;
    
    head = belt_conf[id].head;
    tail = belt_conf[id].tail;
    length = belt_conf[id].length;
    
    /*
    if (head == -1) {
        for (i = 0; i &lt; belt_conf[id].pieces; i++) {
            belts[id][i] = 1;
        }
    }
    else {
        for (i = head; i &lt; belt_conf[id].pieces + head; i++) {
            belts[id][i] = 1;
        }
    }
    */
}

// I need two methods, one that updates from the first segment to the head sensor and one that updates everything else
// this second method if the head is -1 needs to do nothing since the first method has already taken care of everything
void move_head() {
    int i;
    int limit = (head == -1)?length:head;
    
    for (i = 1; i &lt; limit; i++) {
        if (belts[id][i-1] == 0) {
            belts[id][i-1] = belts[id][i];
            belts[id][i] = 0;
        }
    }
}

void move_tail() {
    int i;
    
    if (head != -1) {
        for (i = head+1; i &lt; length; i++) {
            if (belts[id][i-1] == 0) {
                belts[id][i-1] = belts[id][i];
                belts[id][i] = 0;
            }
        }
    }
}


void move_belt() {
    move_head();
    
    if (gate[id]) {
        if (head &gt; 0 &amp;&amp; belts[id][head-1] == 0) {
            belts[id][head-1] = belts[id][head];
            belts[id][head] = 0;
        }
    }
    
    move_tail();
}

void pop() {
    belts[id][0] = 0;
}

bool head_occupied() {
    return belts[id][0];
}

void add_last() {
    belts[id][length-1] = 1;
}</declaration>
		<location id="id63" x="467" y="-152">
			<name x="450" y="-186">start</name>
		</location>
		<location id="id64" x="280" y="-59">
			<name x="187" y="-84">gate_open</name>
		</location>
		<location id="id65" x="51" y="-59">
			<name x="-17" y="-68">moving</name>
			<committed/>
		</location>
		<location id="id66" x="51" y="-229">
			<committed/>
		</location>
		<init ref="id63"/>
		<transition id="id67">
			<source ref="id66"/>
			<target ref="id65"/>
			<label kind="guard" x="-161" y="-212">head == 0 &amp;&amp; !gate[id]</label>
			<label kind="assignment" x="-161" y="-187">move_belt()</label>
			<nail x="-8" y="-144"/>
		</transition>
		<transition id="id68">
			<source ref="id66"/>
			<target ref="id65"/>
			<label kind="guard" x="59" y="-187">head != 0 || (head == 0 &amp;&amp; gate[id])</label>
			<label kind="synchronisation" x="59" y="-170">push[station]!</label>
			<label kind="assignment" x="59" y="-153">pop(), move_belt()</label>
		</transition>
		<transition id="id69">
			<source ref="id64"/>
			<target ref="id66"/>
			<label kind="guard" x="127" y="-272">head_occupied()</label>
			<label kind="synchronisation" x="127" y="-255">tick?</label>
			<nail x="280" y="-229"/>
			<nail x="187" y="-229"/>
		</transition>
		<transition id="id70">
			<source ref="id63"/>
			<target ref="id64"/>
			<label kind="synchronisation" x="324" y="-169">init_done?</label>
			<label kind="assignment" x="324" y="-152">build()</label>
			<nail x="306" y="-152"/>
		</transition>
		<transition id="id71">
			<source ref="id64"/>
			<target ref="id65"/>
			<label kind="guard" x="-93" y="-34">!head_occupied()</label>
			<label kind="synchronisation" x="-93" y="-17">tick?</label>
			<label kind="assignment" x="-93" y="0">move_belt()</label>
			<nail x="178" y="52"/>
			<nail x="51" y="52"/>
		</transition>
		<transition id="id72">
			<source ref="id65"/>
			<target ref="id64"/>
			<label kind="synchronisation" x="85" y="-85">move[id]!</label>
		</transition>
		<transition id="id73">
			<source ref="id64"/>
			<target ref="id64"/>
			<label kind="synchronisation" x="238" y="60">load[id]?</label>
			<label kind="assignment" x="238" y="77">add_last()</label>
			<nail x="331" y="52"/>
			<nail x="229" y="52"/>
		</transition>
	</template>
	<template>
		<name>Initializer</name>
		<declaration>clock x;

void init_all() {
    int i, j;
    
    for (i = 0; i &lt; BELTS; i++) {
        if (belt_conf[i].head == -1) {
            for (j = 0; j &lt; belt_conf[i].pieces; j++) {
                belts[i][i] = 1;
            }
        }
        else {
            for (j = belt_conf[i].head; j &lt; belt_conf[i].pieces + belt_conf[i].head; j++) {
                belts[i][j] = 1;
            }
        }
    }

}</declaration>
		<location id="id74" x="-323" y="-42">
			<name x="-382" y="-76">starting_point</name>
			<committed/>
		</location>
		<location id="id75" x="42" y="-42">
			<name x="0" y="-76">belt_clock</name>
			<label kind="invariant" x="-34" y="-93">x &lt;= 1/BELT_SPEED</label>
		</location>
		<location id="id76" x="-136" y="-42">
			<name x="-170" y="-76">init_over</name>
			<committed/>
		</location>
		<init ref="id74"/>
		<transition id="id77">
			<source ref="id76"/>
			<target ref="id75"/>
			<label kind="synchronisation" x="-93" y="-42">init_done!</label>
		</transition>
		<transition id="id78">
			<source ref="id74"/>
			<target ref="id76"/>
			<label kind="assignment" x="-272" y="-42">init_all()</label>
		</transition>
		<transition id="id79">
			<source ref="id75"/>
			<target ref="id75"/>
			<label kind="guard" x="212" y="-8">x == 1/BELT_SPEED</label>
			<label kind="synchronisation" x="212" y="17">tick!</label>
			<label kind="assignment" x="212" y="42">x = 0</label>
			<nail x="41" y="85"/>
			<nail x="203" y="85"/>
			<nail x="203" y="-42"/>
		</transition>
	</template>
	<system>// Place template instantiations here.
B0 = Belt(0, 0);
S0 = Station(0, 2, 1, true, true);
H0 = HeadSensor(0, 0, 3, 0);
T0 = TailSensor(1, 0, 14, 5);

B1 = Belt(1, 1);
S1 = Station(1, 3, 2, false, true);
H1 = HeadSensor(2, 1, 3, 1);
T1 = TailSensor(3, 1, 13, 0);

B2 = Belt(2, 6);
S2 = FlowController(6);
H2 = HeadSensor(4, 2, 1, 6);

B3 = Belt(3, 2);
S3 = Station(2, 2, 5, true, false);

B4 = Belt(4, 4);
S4 = Station(4, 1, 7, false, true);
H4 = HeadSensor(7, 4, 4, 4);
T4 = TailSensor(8, 4, 13, 6);

B5 = Belt(5, 3);
S5 = Station(3, 6, 6, false, true);
H5 = HeadSensor(5, 5, 3, 3);
T5 = TailSensor(6, 5, 6, 2);

B6 = Belt(6, 7);
S6 = Merger(7,8);

B7 = Belt(7, 7);

B8 = Belt(8, 5);
S8 = Station(5, 2, 0, true, true);
H8 = HeadSensor(9, 8, 1, 5);
T8 = TailSensor(10, 8, 3, 7);


// List one or more processes to be composed into a system.
system Initializer, B0, B1, B2, B3, B4, B5, B6, B7, B8, S0, S1, S2, S3, S4, S5, S6, S8, H0, H1, H2, H4, H5, H8, T0, T1, T4, T5, T8;
</system>
	<queries>
		<query>
			<formula/>
			<comment/>
		</query>
	</queries>
</nta>
